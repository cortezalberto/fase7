# ============================================================================
# AI-Native MVP - Docker Compose for Easypanel
# ============================================================================
# Stack optimizado para deployment en Easypanel:
# - API Backend (FastAPI con uvicorn)
# - PostgreSQL Database
# - Redis Cache
# 
# NO INCLUYE:
# - Frontend (se despliega por separado en Easypanel)
# - Ollama (usar proveedores cloud)
# - Herramientas de debug (pgAdmin, Redis Commander)
# - Monitoring (Prometheus, Grafana)
#
# Uso en Easypanel:
#   1. Crear proyecto nuevo
#   2. Subir este archivo como docker-compose.yml
#   3. Configurar variables de entorno en Easypanel
#   4. Deploy automático
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # API Backend - FastAPI Application
  # ==========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: ai-native-mvp:latest
    ports:
      - "8000:8000"
    environment:
      # Database configuration
      - DATABASE_URL=postgresql://${POSTGRES_USER:-ai_native}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/${POSTGRES_DB:-ai_native}
      - DB_POOL_SIZE=50
      - DB_MAX_OVERFLOW=30
      - DB_POOL_TIMEOUT=5
      - DB_POOL_RECYCLE=3600

      # Redis configuration
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD is required}@redis:6379/0
      - LLM_CACHE_ENABLED=true
      - LLM_CACHE_TTL=3600
      - LLM_CACHE_MAX_ENTRIES=1000

      # LLM Provider - Mistral API (REQUIRED for production)
      - LLM_PROVIDER=${LLM_PROVIDER:-mistral}
      
      # Mistral API
      - MISTRAL_API_KEY=${MISTRAL_API_KEY:?MISTRAL_API_KEY is required}
      - MISTRAL_MODEL=${MISTRAL_MODEL:-mistral-small-latest}
      - MISTRAL_TEMPERATURE=${MISTRAL_TEMPERATURE:-0.7}
      - MISTRAL_TIMEOUT=${MISTRAL_TIMEOUT:-60}
      - MISTRAL_MAX_RETRIES=${MISTRAL_MAX_RETRIES:-3}
      
      # Gemini API (Backup)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
      - GEMINI_TEMPERATURE=${GEMINI_TEMPERATURE:-0.7}
      - GEMINI_TIMEOUT=${GEMINI_TIMEOUT:-30}
      - GEMINI_MAX_RETRIES=${GEMINI_MAX_RETRIES:-3}

      # Security (REQUIRED)
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY is required}

      # Application
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DEBUG=false
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # CORS - Configure with your Easypanel frontend URL
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    networks:
      - ai-native-network

    restart: unless-stopped

    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.8'
        reservations:
          memory: 256M
          cpus: '0.2'

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:15.7-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ai_native}
      - POSTGRES_USER=${POSTGRES_USER:-ai_native}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - ai-native-network

    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ai_native} -d ${POSTGRES_DB:-ai_native}"]
      interval: 10s
      timeout: 5s
      retries: 5

    # Configuración optimizada para producción
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # ==========================================================================
  # Redis Cache
  # ==========================================================================
  redis:
    image: redis:7.2-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - ai-native-network

    restart: unless-stopped

    command:
      - "redis-server"
      - "--requirepass"
      - "${REDIS_PASSWORD:?REDIS_PASSWORD is required}"
      - "--appendonly"
      - "yes"
      - "--appendfsync"
      - "everysec"
      - "--maxmemory"
      - "256mb"
      - "--maxmemory-policy"
      - "allkeys-lru"

    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 64M

# ============================================================================
# Networks
# ============================================================================
networks:
  ai-native-network:
    driver: bridge

# ============================================================================
# Volumes (Persistencia de Datos)
# ============================================================================
volumes:
  postgres_data:
    driver: local

  redis_data:
    driver: local

# ============================================================================
# Notas de Configuración para Easypanel
# ============================================================================
#
# VARIABLES DE ENTORNO REQUERIDAS:
# Configurar en Easypanel > Project > Environment Variables
#
#   POSTGRES_PASSWORD=<strong_password>      # PostgreSQL password
#   REDIS_PASSWORD=<strong_password>         # Redis password
#   JWT_SECRET_KEY=<random_64_chars>         # JWT signing key
#   SECRET_KEY=<random_64_chars>             # App secret key
#   MISTRAL_API_KEY=<api_key>                # Mistral AI API key
#
# VARIABLES OPCIONALES:
#   POSTGRES_USER=ai_native                  # Default: ai_native
#   POSTGRES_DB=ai_native                    # Default: ai_native
#   LLM_PROVIDER=mistral                     # Default: mistral
#   MISTRAL_MODEL=mistral-small-latest       # Default: mistral-small-latest
#   ENVIRONMENT=production                   # Default: production
#   LOG_LEVEL=INFO                           # Default: INFO
#   ALLOWED_ORIGINS=https://yourapp.com      # Configure with your frontend URL
#   GEMINI_API_KEY=<api_key>                 # Optional: Gemini backup
#
# GENERAR SECRETOS:
#   JWT_SECRET_KEY: openssl rand -hex 32
#   SECRET_KEY: openssl rand -hex 32
#   POSTGRES_PASSWORD: openssl rand -base64 24
#   REDIS_PASSWORD: openssl rand -base64 24
#
# ACCESO A SERVICIOS:
#   API: http://<easypanel-domain>:8000
#   API Docs: http://<easypanel-domain>:8000/docs
#   Health Check: http://<easypanel-domain>:8000/api/v1/health
#
# FRONTEND DEPLOYMENT:
#   El frontend se debe desplegar por separado en Easypanel como servicio estático
#   o usando nginx. Configurar ALLOWED_ORIGINS con la URL del frontend.
#
# MONITOREO:
#   - Logs: Easypanel > Service > Logs
#   - Health: Easypanel verificará /api/v1/health automáticamente
#   - Metrics: Agregar Prometheus/Grafana como servicios adicionales si necesario
#
# BACKUPS:
#   1. PostgreSQL: Configurar backup automático en Easypanel
#   2. Redis: El volumen redis_data persiste automáticamente
#
# SCALING:
#   - API: Escalar horizontalmente en Easypanel (múltiples réplicas)
#   - PostgreSQL: Vertical scaling (aumentar memoria/CPU)
#   - Redis: Considerar Redis Cluster para alta disponibilidad
#
# TROUBLESHOOTING:
#   - Verificar logs: Easypanel > Service > Logs
#   - Verificar health checks: Debe mostrar "healthy"
#   - Verificar conectividad: API debe poder conectar a postgres y redis
#
# ============================================================================
