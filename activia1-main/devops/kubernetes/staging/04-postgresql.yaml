# ============================================================================
# AI-Native MVP - PostgreSQL StatefulSet
# ============================================================================
# PostgreSQL 15 with SecurityContext and optimized settings
# ============================================================================

apiVersion: v1
kind: Service
metadata:
  name: ai-native-postgresql
  namespace: ai-native-staging
  labels:
    app: postgresql
    tier: database
spec:
  type: ClusterIP
  ports:
  - port: 5432
    targetPort: 5432
    protocol: TCP
    name: postgresql
  selector:
    app: postgresql
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
  namespace: ai-native-staging
  labels:
    app: postgresql
    tier: database
spec:
  serviceName: ai-native-postgresql
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
  template:
    metadata:
      labels:
        app: postgresql
        tier: database
    spec:
      # Security Context - PostgreSQL runs as user postgres (UID 70 in Alpine)
      securityContext:
        runAsNonRoot: true
        runAsUser: 70
        runAsGroup: 70
        fsGroup: 70

      containers:
      - name: postgresql
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
          name: postgresql

        env:
        - name: POSTGRES_DB
          value: ai_native
        - name: POSTGRES_USER
          value: ai_native
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: ai-native-secrets
              key: POSTGRES_PASSWORD
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        # PostgreSQL tuning
        - name: POSTGRES_INITDB_ARGS
          value: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"

        # Security context for container
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

        # OPT-017: Resource limits ratio adjusted to 2:1 for better scheduling
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 1000m   # 2:1 ratio (was 4:1)
            memory: 4Gi  # 2:1 ratio (was 4:1)

        volumeMounts:
        - name: postgresql-data
          mountPath: /var/lib/postgresql/data
        - name: postgresql-config
          mountPath: /etc/postgresql/conf.d
          readOnly: true

        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U ai_native -d ai_native
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - pg_isready -U ai_native -d ai_native
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2

      volumes:
      - name: postgresql-config
        configMap:
          name: postgresql-config
          optional: true

  volumeClaimTemplates:
  - metadata:
      name: postgresql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: standard
      resources:
        requests:
          storage: 50Gi
---
# ============================================================================
# PostgreSQL Configuration (optional tuning)
# ============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-config
  namespace: ai-native-staging
  labels:
    app: postgresql
data:
  # Custom PostgreSQL settings
  # These are mounted to /etc/postgresql/conf.d/
  # OPT-017: PostgreSQL memory settings aligned with 4Gi limit
  custom.conf: |
    # Connection settings
    max_connections = 200

    # Memory settings (tuned for 4Gi limit)
    shared_buffers = 1GB           # ~25% of available memory
    effective_cache_size = 3GB     # ~75% of available memory
    maintenance_work_mem = 256MB   # For maintenance operations
    work_mem = 8MB                 # Per-operation memory

    # WAL settings
    wal_buffers = 32MB
    min_wal_size = 1GB
    max_wal_size = 4GB
    checkpoint_completion_target = 0.9

    # Query planner
    random_page_cost = 1.1
    effective_io_concurrency = 200
    default_statistics_target = 100

    # Logging (for debugging)
    log_statement = 'ddl'
    log_duration = off
    log_min_duration_statement = 1000

    # Security
    ssl = off  # Enable in production with proper certs
    log_connections = on
    log_disconnections = on
