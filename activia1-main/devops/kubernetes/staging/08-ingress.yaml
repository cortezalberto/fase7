# ============================================================================
# AI-Native MVP - Ingress Configuration
# ============================================================================
# NGINX Ingress with TLS, rate limiting, and security headers
#
# IMPORTANT: Update the hostnames before deploying!
#   - Replace "example.com" with your actual domain
#   - Or use environment substitution with envsubst
#
# Example with envsubst:
#   export DOMAIN=myuniversity.edu
#   envsubst < 08-ingress.yaml | kubectl apply -f -
# ============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ai-native-ingress
  namespace: ai-native-staging
  labels:
    app: ai-native
    environment: staging
  annotations:
    # =========================================================================
    # Cert-Manager for automatic SSL/TLS
    # =========================================================================
    # Use letsencrypt-staging for testing, letsencrypt-prod for production
    cert-manager.io/cluster-issuer: letsencrypt-staging

    # =========================================================================
    # NGINX Ingress settings
    # =========================================================================
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # =========================================================================
    # Rate limiting
    # =========================================================================
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-rpm: "6000"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # =========================================================================
    # Request size limits
    # =========================================================================
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # =========================================================================
    # Timeouts (increased for LLM operations)
    # =========================================================================
    nginx.ingress.kubernetes.io/proxy-read-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"

    # =========================================================================
    # CORS (for API)
    # =========================================================================
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # =========================================================================
    # Security headers (OWASP recommended)
    # =========================================================================
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Permissions-Policy: geolocation=(), microphone=(), camera=()";

spec:
  ingressClassName: nginx

  tls:
  - hosts:
    # UPDATE THESE HOSTNAMES before deploying!
    # Example: api-staging.myuniversity.edu
    - api-staging.ai-native.${DOMAIN:-example.com}
    - app-staging.ai-native.${DOMAIN:-example.com}
    secretName: ai-native-staging-tls

  rules:
  # =========================================================================
  # API Backend
  # =========================================================================
  # UPDATE: Replace example.com with your actual domain
  - host: api-staging.ai-native.${DOMAIN:-example.com}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ai-native-backend
            port:
              number: 8000

  # =========================================================================
  # Frontend
  # =========================================================================
  # UPDATE: Replace example.com with your actual domain
  - host: app-staging.ai-native.${DOMAIN:-example.com}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ai-native-frontend
            port:
              number: 80

# ============================================================================
# DEPLOYMENT INSTRUCTIONS
# ============================================================================
#
# Option 1: Using envsubst (recommended for CI/CD)
#   export DOMAIN=myuniversity.edu
#   envsubst < 08-ingress.yaml | kubectl apply -f -
#
# Option 2: Manual edit
#   1. Replace all occurrences of ${DOMAIN:-example.com} with your domain
#   2. kubectl apply -f 08-ingress.yaml
#
# Option 3: Using kustomize (for multiple environments)
#   Create a kustomization.yaml with patches for each environment
#
# PREREQUISITES:
#   1. NGINX Ingress Controller must be installed
#      kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.0/deploy/static/provider/cloud/deploy.yaml
#
#   2. Cert-Manager must be installed for TLS
#      kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
#   3. ClusterIssuer must be configured
#      See setup-ingress.sh for details
#
# ============================================================================
